---
phase: 03-notification-reliability-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/telegram/formatter.ts
  - src/index.ts
  - render.yaml
autonomous: true

must_haves:
  truths:
    - "A digest message combining multiple alerts can be formatted as a single Telegram-safe HTML message"
    - "The bot saves state and exits cleanly on SIGTERM/SIGINT signals"
    - "The bot can be deployed as a Render Background Worker using render.yaml"
  artifacts:
    - path: "src/telegram/formatter.ts"
      provides: "formatDigest function for batched alerts"
      exports: ["formatDigest"]
    - path: "src/index.ts"
      provides: "Graceful shutdown handler for SIGTERM/SIGINT"
      contains: "SIGTERM"
    - path: "render.yaml"
      provides: "Render Background Worker deployment blueprint"
      contains: "type: worker"
  key_links:
    - from: "src/index.ts"
      to: "StateStore.save()"
      via: "SIGTERM handler saves state before exit"
      pattern: "store\\.save"
    - from: "render.yaml"
      to: "dist/index.js"
      via: "startCommand"
      pattern: "node dist/index.js"
---

<objective>
Add digest formatter for batched alerts, wire graceful shutdown in the entry point, and create the Render deployment blueprint.

Purpose: The digest formatter enables sending a single combined message when many repos trend at once (keeps the Telegram group clean). Graceful shutdown ensures state is saved before Render stops the worker. The render.yaml makes deployment reproducible and version-controlled.
Output: Digest formatting capability, shutdown handler, deployment config.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-notification-reliability-deployment/03-RESEARCH.md
@src/telegram/formatter.ts
@src/index.ts
@src/state/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add digest formatter for batched alerts</name>
  <files>src/telegram/formatter.ts</files>
  <action>
Add a new exported function `formatDigest` to `src/telegram/formatter.ts`. This formats multiple alerts into a single compact Telegram message.

**Define the digest data type:**

```typescript
export interface DigestEntry {
  owner: string;
  name: string;
  stars: number;
  starsPerDay: number;
  tier: SeverityTier | "new";
}
```

The `tier` field accepts "new" in addition to SeverityTier values to handle new repo alerts in the digest.

**Implement `formatDigest(entries: DigestEntry[]): string`:**

1. Header line: `"<b>Trending Digest</b> -- {entries.length} repos trending"`
2. Blank line separator
3. For each entry (max 20 entries to stay under Telegram's 4096-char limit):
   - Format: `{emoji} <a href="https://github.com/{owner}/{name}">{owner}/{name}</a> -- {stars} stars (+{starsPerDay}/day)`
   - For "new" tier entries: use sparkles emoji and format as `{emoji} <a href="...">{owner}/{name}</a> -- {stars} stars [NEW]` (no starsPerDay for new repos)
   - Use `escapeHtml()` on owner and name (existing helper)
4. If entries.length > 20: append a footer line `"\n...and {entries.length - 20} more"`
5. Join all lines with `\n`

**Emoji mapping for digest:** Reuse the existing `TIER_EMOJI` record for severity tiers. For "new" tier, use the sparkles emoji (`\u2728`).

Keep the function pure -- no side effects, just string formatting. The caller (cycle.ts in Plan 03) decides when to use digest vs individual alerts.
  </action>
  <verify>
Run `npm run build` -- should compile with no errors. Verify `formatDigest` is exported by checking the built declaration file or grepping the source.
  </verify>
  <done>
`formatDigest(entries)` is exported from formatter.ts. It produces a compact HTML digest message with header, per-repo lines (emoji + linked name + stars + velocity), and truncation at 20 entries. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add graceful shutdown and create Render deployment config</name>
  <files>src/index.ts, render.yaml</files>
  <action>
**Part A: Graceful shutdown in `src/index.ts`**

Add a `setupGracefulShutdown` function and call it from `main()`:

```typescript
function setupGracefulShutdown(store: StateStore): void {
  const shutdown = async (signal: string) => {
    log.info({ signal }, "Shutdown signal received, saving state");
    try {
      await store.save();
      log.info("State saved, exiting");
    } catch (err) {
      log.error({ err }, "Failed to save state on shutdown");
    }
    process.exit(0);
  };

  process.on("SIGTERM", () => shutdown("SIGTERM"));
  process.on("SIGINT", () => shutdown("SIGINT"));
}
```

Call `setupGracefulShutdown(store)` in `main()` AFTER `store.load()` and BEFORE `startScheduler()`. This ensures the store is loaded and ready before registering handlers.

**Part B: Create `render.yaml` at project root**

Create the Render Background Worker blueprint:

```yaml
services:
  - type: worker
    name: gitscope
    runtime: node
    plan: starter
    region: oregon
    buildCommand: npm install && npm run build
    startCommand: node dist/index.js
    autoDeploy: true
    envVars:
      - key: GITHUB_TOKEN
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_CHAT_ID
        sync: false
      - key: LOG_LEVEL
        value: info
      - key: STATE_FILE_PATH
        value: ./state.json
      - key: NODE_ENV
        value: production
```

Notes:
- `type: worker` means no HTTP port, just a background process
- `sync: false` means secrets are entered manually in Render dashboard, not stored in yaml
- `runtime: node` (not `env: node` -- Render uses `runtime` in render.yaml)
- `plan: starter` is the cheapest always-on tier
- `autoDeploy: true` deploys on every push to the connected branch
  </action>
  <verify>
1. `npm run build` succeeds
2. `grep -q "SIGTERM" src/index.ts` confirms shutdown handler
3. `cat render.yaml` shows valid YAML with `type: worker` service
  </verify>
  <done>
index.ts registers SIGTERM and SIGINT handlers that save state and exit cleanly. render.yaml defines the Render Background Worker with correct env vars (secrets marked sync:false, defaults for non-sensitive vars). Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `grep -q "formatDigest" src/telegram/formatter.ts` confirms digest formatter exists
3. `grep -q "SIGTERM" src/index.ts` confirms graceful shutdown
4. `test -f render.yaml` confirms deployment config exists
5. `grep -q "type: worker" render.yaml` confirms background worker type
</verification>

<success_criteria>
- formatDigest produces a compact digest message combining multiple alert entries
- Digest truncates at 20 entries with "and N more" footer
- SIGTERM/SIGINT handlers save state before exiting
- render.yaml defines a Render Background Worker with all required env vars
- TypeScript builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-notification-reliability-deployment/03-02-SUMMARY.md`
</output>
