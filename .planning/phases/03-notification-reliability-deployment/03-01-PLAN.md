---
phase: 03-notification-reliability-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config.ts
  - src/telegram/sender.ts
autonomous: true

must_haves:
  truths:
    - "Telegram 429 and 5xx errors are retried automatically with exponential backoff"
    - "HTML parse errors (400) fall back to plain text instead of dropping the notification"
    - "COOLDOWN_DAYS and BATCH_THRESHOLD are configurable via environment variables with sensible defaults"
  artifacts:
    - path: "src/telegram/sender.ts"
      provides: "Resilient Telegram sender with auto-retry and plain-text fallback"
      contains: "autoRetry"
    - path: "src/config.ts"
      provides: "Extended config with COOLDOWN_DAYS and BATCH_THRESHOLD"
      contains: "COOLDOWN_DAYS"
    - path: "package.json"
      provides: "@grammyjs/auto-retry dependency"
      contains: "@grammyjs/auto-retry"
  key_links:
    - from: "src/telegram/sender.ts"
      to: "@grammyjs/auto-retry"
      via: "bot.api.config.use(autoRetry(...))"
      pattern: "autoRetry"
    - from: "src/telegram/sender.ts"
      to: "GrammyError"
      via: "400 parse error detection and plain-text fallback"
      pattern: "can't parse entities"
---

<objective>
Install @grammyjs/auto-retry, extend config with notification tuning env vars, and make the Telegram sender resilient with transport-level retry and plain-text fallback.

Purpose: Failed Telegram deliveries must not silently drop notifications. Transport errors (429/5xx) get retried automatically, and HTML formatting errors degrade gracefully to plain text.
Output: Resilient sender, extended config, new dependency installed.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-notification-reliability-deployment/03-RESEARCH.md
@src/config.ts
@src/telegram/sender.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install auto-retry and extend config</name>
  <files>package.json, src/config.ts</files>
  <action>
1. Install @grammyjs/auto-retry:
   ```bash
   npm install @grammyjs/auto-retry
   ```

2. In `src/config.ts`, add two new fields to `envSchema`:

   ```typescript
   COOLDOWN_DAYS: z
     .string()
     .default("7")
     .transform((s) => parseInt(s, 10))
     .pipe(z.number().min(1).max(90)),
   BATCH_THRESHOLD: z
     .string()
     .default("5")
     .transform((s) => parseInt(s, 10))
     .pipe(z.number().min(1).max(100)),
   ```

   Place these after the existing MONITOR_CRON field. These are string-to-number transforms following the same pattern as existing config fields. COOLDOWN_DAYS controls how many days before a repo can be re-alerted. BATCH_THRESHOLD controls when alerts switch from individual to digest format.
  </action>
  <verify>
Run `npm run build` -- should compile with no errors. Verify `@grammyjs/auto-retry` appears in package.json dependencies and in node_modules.
  </verify>
  <done>
package.json has @grammyjs/auto-retry dependency installed. Config exports COOLDOWN_DAYS (default 7, min 1, max 90) and BATCH_THRESHOLD (default 5, min 1, max 100) as numbers derived from env var strings. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make sender resilient with auto-retry and plain-text fallback</name>
  <files>src/telegram/sender.ts</files>
  <action>
Rewrite `createTelegramSender` in `src/telegram/sender.ts` to add two layers of resilience:

**Layer 1: Transport-level retry (auto-retry plugin)**

Import `autoRetry` from `@grammyjs/auto-retry`. After creating the `Bot` instance, configure the API transformer:

```typescript
import { autoRetry } from "@grammyjs/auto-retry";

bot.api.config.use(autoRetry({
  maxRetryAttempts: 3,
  maxDelaySeconds: 60,
}));
```

This handles 429 (rate limit with retry_after) and 5xx (server error) responses at the transport layer before our application code sees them. Place this right after `const bot = new Bot(botToken)`.

**Layer 2: Application-level plain-text fallback**

Replace the current `send` method with a two-attempt strategy:

1. First attempt: send with `parse_mode: "HTML"` (current behavior).
2. On `GrammyError` where `error_code === 400` AND `description` includes `"can't parse entities"`:
   - Log a warning: "HTML parse failed, falling back to plain text"
   - Strip HTML tags from the message using: `message.replace(/<[^>]*>/g, "").replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, '"')`
   - Send again WITHOUT `parse_mode` (plain text)
   - If fallback also fails, log error and return false
3. On other `GrammyError` (non-parse errors already retried by auto-retry plugin): log error, return false.
4. On `HttpError` (retries exhausted by auto-retry): log error, return false.
5. On unknown error: log error, return false.

Keep the `TelegramSender` interface unchanged (`send(message: string): Promise<boolean>`). The resilience is internal to the implementation.

Helper function `stripHtml(html: string): string` can be a module-level function (not exported) since it is only used by the sender.
  </action>
  <verify>
Run `npm run build` -- should compile with no errors. Inspect the built output `dist/telegram/sender.js` to confirm autoRetry import and fallback logic are present.
  </verify>
  <done>
Sender configures auto-retry with maxRetryAttempts=3 and maxDelaySeconds=60 on the Bot API. On 400 parse errors, sender strips HTML and retries as plain text. On all other errors, sender returns false without crashing. TelegramSender interface unchanged. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `grep -q "autoRetry" src/telegram/sender.ts` confirms auto-retry integration
3. `grep -q "can't parse entities" src/telegram/sender.ts` confirms parse error detection
4. `grep -q "COOLDOWN_DAYS" src/config.ts` confirms config extension
5. `grep -q "@grammyjs/auto-retry" package.json` confirms dependency
</verification>

<success_criteria>
- @grammyjs/auto-retry installed and integrated into the Bot API transformer
- Sender detects HTML parse errors and falls back to plain text
- Config exports COOLDOWN_DAYS (default 7) and BATCH_THRESHOLD (default 5) as numbers
- TelegramSender interface unchanged (no downstream breakage)
- TypeScript builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-notification-reliability-deployment/03-01-SUMMARY.md`
</output>
