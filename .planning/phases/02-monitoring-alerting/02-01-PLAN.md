---
phase: 02-monitoring-alerting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/config.ts
  - src/state/schema.ts
  - src/github/client.ts
  - src/github/search.ts
autonomous: true

must_haves:
  truths:
    - "GitHub search queries combine all 6 keywords using OR operator into 1 query to minimize API calls"
    - "GitHub client automatically handles rate limits via @octokit/plugin-throttling with retry on primary limits and backoff on secondary limits"
    - "Config includes monitoring keywords, velocity thresholds, and cron expression as validated fields"
    - "State schema stores language field per repo snapshot for alert formatting"
  artifacts:
    - path: "src/github/client.ts"
      provides: "Throttled Octokit instance factory"
      exports: ["createGitHubClient"]
    - path: "src/github/search.ts"
      provides: "GitHub search query builder and executor"
      exports: ["searchRepos"]
    - path: "src/config.ts"
      provides: "Extended config with monitoring fields"
      contains: "MONITOR_KEYWORDS"
    - path: "src/state/schema.ts"
      provides: "Updated state schema with language field"
      contains: "language"
  key_links:
    - from: "src/github/client.ts"
      to: "@octokit/plugin-throttling"
      via: "Octokit.plugin(throttling)"
      pattern: "Octokit\\.plugin\\(throttling\\)"
    - from: "src/github/search.ts"
      to: "src/github/client.ts"
      via: "accepts Octokit instance parameter"
      pattern: "octokit.*search\\.repos"
    - from: "src/github/search.ts"
      to: "src/config.ts"
      via: "uses keywords from config to build query"
      pattern: "OR"
---

<objective>
Create the GitHub integration layer: install @octokit/plugin-throttling, extend config with monitoring parameters, update state schema with language field, build the throttled GitHub client and search module.

Purpose: Establishes the GitHub API foundation that the monitoring cycle depends on -- search queries, rate limit protection, and configurable keywords/thresholds.
Output: Configured GitHub client with automatic rate limiting, search function that combines keywords into efficient queries, extended config and state schema.
</objective>

<execution_context>
@/Users/uzi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/uzi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-monitoring-alerting/02-RESEARCH.md
@src/config.ts
@src/state/schema.ts
@src/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install throttling plugin, extend config and state schema</name>
  <files>
    package.json
    src/config.ts
    src/state/schema.ts
  </files>
  <action>
1. Install the new dependency:
   ```bash
   npm install @octokit/plugin-throttling
   ```
   This is the ONLY new dependency for Phase 2. Verify it installs without peer dep warnings (needs @octokit/core ^7.0.0, satisfied by @octokit/rest v22's @octokit/core@7.0.6).

2. Extend `src/config.ts` -- add monitoring config fields to envSchema:
   - `MONITOR_KEYWORDS`: z.string().default("openclaw,claude-code,clawdbot,moltbot,clawhub,openclaw skills") -- comma-separated, parsed to string[] via .transform(s => s.split(",").map(k => k.trim()))
   - `MONITOR_CRON`: z.string().default("*/30 * * * *") -- cron expression for monitoring cycle
   - Do NOT add velocity thresholds as env vars. Per research recommendation, these are business logic constants defined in code (classifier.ts in Plan 02), not runtime config.

3. Extend `src/state/schema.ts` -- add `language` field to the snapshot objects inside repoSnapshotSchema:
   - Add `language: z.string().nullable()` to the repo-level fields in repoSnapshotSchema (alongside owner, name, description, topics, addedAt)
   - This is a repo-level field (language rarely changes), NOT a per-snapshot field
   - Update EMPTY_STATE if needed (it should remain the same since repos starts as {})
  </action>
  <verify>
    Run `npm ls @octokit/plugin-throttling` to confirm installation. Run `npx tsc --noEmit` to confirm no type errors after config and schema changes.
  </verify>
  <done>
    @octokit/plugin-throttling installed without peer dep issues. Config exports MONITOR_KEYWORDS as string[] and MONITOR_CRON as string with defaults. State schema includes language field on repo snapshots. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub client and search module</name>
  <files>
    src/github/client.ts
    src/github/search.ts
  </files>
  <action>
1. Create `src/github/client.ts`:
   - Import `Octokit` from "@octokit/rest" and `throttling` from "@octokit/plugin-throttling"
   - Create `ThrottledOctokit = Octokit.plugin(throttling)`
   - Export `createGitHubClient(token: string)` that returns a new ThrottledOctokit instance
   - Configure throttle callbacks:
     - `onRateLimit`: Log warning with method, url, retryAfter, retryCount. Return true if retryCount < 1 (retry once), false otherwise.
     - `onSecondaryRateLimit`: Log warning with method, url, retryAfter. Return false (do not retry secondary limits -- back off entirely).
   - Use `createLogger("github")` for logging
   - Export the `ThrottledOctokit` type for use in search.ts: `export type GitHubClient = InstanceType<typeof ThrottledOctokit>`

2. Create `src/github/search.ts`:
   - Export `buildSearchQuery(keywords: string[]): string` -- combines keywords with OR operator. Multi-word keywords get quoted. Appends `in:name,description,topics,readme` qualifier. Example output: `'openclaw OR claude-code OR clawdbot OR moltbot OR clawhub OR "openclaw skills" in:name,description,topics,readme'`
   - Export interface `SearchResult` with fields: owner (string), name (string), fullName (string), description (string | null), stars (number), forks (number), language (string | null), createdAt (string), topics (string[])
   - Export `searchRepos(client: GitHubClient, keywords: string[]): Promise<SearchResult[]>` that:
     - Calls `client.rest.search.repos({ q: buildSearchQuery(keywords), sort: "updated", order: "desc", per_page: 100 })`
     - Maps `data.items` to `SearchResult[]` (extracting: owner.login, name, full_name, description, stargazers_count, forks_count, language, created_at, topics)
     - Logs warning if `data.incomplete_results === true`
     - Logs info with total_count and items.length
     - Uses `createLogger("github:search")` for logging
   - Do NOT paginate -- at per_page: 100, niche keywords will return well under 100 results. Pagination adds complexity without value for the ecosystem size.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm both files compile. Verify exports: `grep -n "export" src/github/client.ts src/github/search.ts` should show createGitHubClient, GitHubClient, buildSearchQuery, SearchResult, searchRepos.
  </verify>
  <done>
    src/github/client.ts exports createGitHubClient and GitHubClient type with throttling plugin configured. src/github/search.ts exports buildSearchQuery (OR-combined keywords), SearchResult interface, and searchRepos function. Both compile without errors.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @octokit/plugin-throttling` shows installed version ^11.x with no peer dep warnings
2. `npx tsc --noEmit` passes with zero errors
3. Config exports MONITOR_KEYWORDS as string[] (default 6 keywords) and MONITOR_CRON as string
4. State schema repoSnapshotSchema includes `language: z.string().nullable()`
5. GitHub client creates throttled Octokit with onRateLimit and onSecondaryRateLimit callbacks
6. Search query builder produces correct OR-combined query with in:name,description,topics,readme qualifier
</verification>

<success_criteria>
All 5 new/modified files compile without TypeScript errors. The GitHub client and search modules are ready for the monitoring cycle to import and use. Config and state schema extensions support the full Phase 2 data model.
</success_criteria>

<output>
After completion, create `.planning/phases/02-monitoring-alerting/02-01-SUMMARY.md`
</output>
